{{define "game_topright"}}
<div class="badge">üéØ {{.Difficulty}}</div>
{{end}}

{{define "game_content"}}
{{$root := .}}

<section class="status">
    <div>Au tour de :
        <span id="playerLabel" style="color:{{if eq .CurrentStr "R"}}var(--red){{else}}var(--yellow){{end}};">
        {{if eq .CurrentStr "R"}}{{.P1}}{{else}}{{.P2}}{{end}}
        </span>
    </div>
    <div id="score">
        <span>üî¥ {{.P1}}: <strong>{{.Scores.R}}</strong></span>
        <span>üü° {{.P2}}: <strong>{{.Scores.Y}}</strong></span>
    </div>
    {{if .IsOnline}}
    <div class="badge">Salle: <strong>{{.LobbyCode}}</strong></div>
    {{end}}
</section>

{{/* ---- Sounds (MP3) ---- */}}
<audio id="sndClick" preload="auto">
    <source src="/static/sounds/click.mp3" type="audio/mpeg">
</audio>
<audio id="sndDrop" preload="auto">
    <source src="/static/sounds/piece_drop.mp3" type="audio/mpeg">
</audio>
<audio id="sndRise" preload="auto">
    <source src="/static/sounds/piece_rise.mp3" type="audio/mpeg">
</audio>
<!-- Start sound -->
<audio id="sndStart" preload="auto">
    <source src="/static/sounds/start.mp3" type="audio/mpeg">
</audio>

{{if .GravityUp}}
<div class="notice invert">üß≤ Gravit√© invers√©e (les pions montent) ‚Äî (tous les 5 tours)</div>
{{else}}
<div class="notice">‚§µÔ∏è Gravit√© normale (les pions descendent) ‚Äî (tous les 5 tours)</div>
{{end}}

<section class="board" aria-label="Board" role="grid"
         style="grid-template-columns: repeat({{len .Cols}}, 1fr);">
    {{range $c := .Cols}}
    <div class="col" style="grid-template-rows: repeat({{len $root.Rows}}, 1fr);">
        {{range $r := $root.Rows}}
        {{$cell := index (index $root.Grid $r) $c}}
        <div class="cell {{if index $root.Winning $r $c}}winner{{end}}">
            {{if eq $cell 82}}<div class="piece red"></div>{{end}}    <!-- 'R' -->
            {{if eq $cell 89}}<div class="piece yellow"></div>{{end}} <!-- 'Y' -->
            {{if eq $cell 88}}<div class="piece block"></div>{{end}}  <!-- 'X' -->
        </div>
        {{end}}

        <form method="post" action="{{if $root.IsOnline}}/online/play{{else}}/play{{end}}" class="col-form">
            {{if $root.IsOnline}}
            <input type="hidden" name="code" value="{{$root.LobbyCode}}">
            <input type="hidden" name="side" value="{{if $root.ThisIsRed}}R{{else}}Y{{end}}">
            {{end}}
            <button
                    type="submit"
                    name="col"
                    value="{{$c}}"
                    class="col-hit"
                    {{if index $root.Disabled $c}}disabled{{end}}
                    title="D√©poser dans la colonne {{$c}}">
            </button>
        </form>
    </div>
    {{end}}
</section>

{{if .IsOnline}}
<!-- ===== Mini-Chat (en ligne) ===== -->
<aside class="chat-panel">
    <div class="chat-header">üí¨ Chat de la salle <strong>{{.LobbyCode}}</strong></div>
    <div id="chatList" class="chat-list" aria-live="polite"></div>

    <form id="chatForm" class="chat-form" autocomplete="off">
        <input type="text" id="chatInput" name="text" placeholder="√âcrire un message‚Ä¶" maxlength="240" required>
        <button type="submit" class="btn-primary">Envoyer</button>
    </form>
</aside>
{{end}}

<script>
    (function () {
        /* ---------- Sounds ---------- */
        const sndClick = document.getElementById("sndClick");
        const sndDrop  = document.getElementById("sndDrop");
        const sndRise  = document.getElementById("sndRise");
        const sndStart = document.getElementById("sndStart");

        // Unlock audio on first user gesture (mobile autoplay policies)
        const arm = () => {
            [sndClick, sndDrop, sndRise, sndStart].forEach(a => {
                try { a.muted = false; a.play().then(() => a.pause()).catch(()=>{}); } catch(_) {}
            });
        };
        window.addEventListener("pointerdown", arm, { once: true });
        window.addEventListener("keydown", arm, { once: true });

        // Play start sound when a fresh match loads (server sets .PlayStart)
        const shouldStart = {{if .PlayStart}}true{{else}}false{{end}};
        if (shouldStart) {
            try { sndStart.currentTime = 0; sndStart.play(); } catch(_) {}
        }

        // Play click when user presses a column; also mark that we initiated a move
        const nowTurns = {{.Turns}};
        document.querySelectorAll(".col-hit").forEach(btn => {
            btn.addEventListener("click", () => {
                try { sndClick.currentTime = 0; sndClick.play(); } catch(_) {}
                // Remember we submitted at this turn count; after reload we expect nowTurns+1
                sessionStorage.setItem("movedTurns", String(nowTurns));
            });
        });

        // After reload: if a move just happened from this browser, play drop/rise
        const stored = parseInt(sessionStorage.getItem("movedTurns") || "-1", 10);
        if (!Number.isNaN(stored) && stored === nowTurns - 1) {
            const gravUp = {{if .GravityUp}}true{{else}}false{{end}};
            try {
                if (gravUp) { sndRise.currentTime = 0; sndRise.play(); }
                else        { sndDrop.currentTime = 0; sndDrop.play(); }
            } catch(_) {}
            sessionStorage.removeItem("movedTurns");
        }

        /* ---------- Online polling ---------- */
        {{if .IsOnline}}
        const code = "{{.LobbyCode}}";
        let lastTurns = nowTurns; // initial server value

        async function tick() {
            try {
                const res = await fetch("/online/state?code=" + encodeURIComponent(code), { cache: "no-store" });
                if (!res.ok) return;
                const j = await res.json();
                if (j.gameOver || j.turns !== lastTurns) {
                    location.reload();
                    return;
                }
                lastTurns = j.turns;
            } catch (_) {}
        }
        setInterval(tick, 1200);

        /* ---------- Mini-Chat (polling) ---------- */
        const chatList  = document.getElementById('chatList');
        const chatForm  = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        let lastChatID = 0;

        const mySide = "{{if .ThisIsRed}}R{{else}}Y{{end}}";
        const myName = "{{if .ThisIsRed}}{{.P1}}{{else}}{{.P2}}{{end}}";

        function appendMsg(m){
            const item = document.createElement('div');
            item.className = 'chat-item ' + (m.side === 'R' ? 'chat-r' : 'chat-y');
            const who = document.createElement('span');
            who.className = 'chat-who';
            who.textContent = (m.side === 'R' ? 'üî¥ ' : 'üü° ') + m.name + ' : ';
            const txt = document.createElement('span');
            txt.className = 'chat-text';
            txt.textContent = m.text;
            item.appendChild(who);
            item.appendChild(txt);
            chatList.appendChild(item);
            chatList.scrollTop = chatList.scrollHeight;
        }

        async function pollChat(){
            try{
                const res = await fetch(`/chat/feed?code=${encodeURIComponent(code)}&since=${lastChatID}`, { cache:"no-store" });
                if(!res.ok) return;
                const j = await res.json();
                if (j.items && j.items.length){
                    j.items.forEach(m => {
                        appendMsg(m);
                        if (m.id > lastChatID) lastChatID = m.id;
                    });
                }
            }catch(_){}
        }
        setInterval(pollChat, 1200);
        pollChat();

        if (chatForm){
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = (chatInput.value || "").trim();
                if (!text) return;
                const fd = new FormData();
                fd.append('code', code);
                fd.append('side', mySide);
                fd.append('name', myName);
                fd.append('text', text);
                try{
                    const r = await fetch('/chat/post', { method:'POST', body: fd });
                    if (r.ok){
                        chatInput.value = '';
                        // local echo for instant feedback
                        appendMsg({id: lastChatID+1, side: mySide, name: myName, text});
                        lastChatID++;
                    }
                }catch(_){}
            });
        }
        {{end}}
    })();
</script>
{{end}}
