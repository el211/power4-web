{{define "result_topright"}}
<div class="badge">üéØ {{.Difficulty}}</div>
{{end}}

{{define "result_content"}}
<section class="card center">
    {{if .Message}}
    <h2>{{.Message}}</h2>
    {{else}}
    <h2>
        {{if eq .LastPlayed "R"}}
        Victoire de {{.P1}} !
        {{else if eq .LastPlayed "Y"}}
        Victoire de {{.P2}} !
        {{else}}
        Partie termin√©e !
        {{end}}
    </h2>
    {{end}}

    <p>
        Score ‚Äî {{.P1}}: <strong>{{.Scores.R}}</strong> | {{.P2}}: <strong>{{.Scores.Y}}</strong>
    </p>

    {{if .IsOnline}}
    <p>
        Salle : <strong>{{.LobbyCode}}</strong>
    </p>
    <p id="rematchStatus" class="hint">
        Revanche : 0/2 pr√™ts
    </p>
    {{end}}

    <!-- Win sound -->
    <audio id="sndWin" preload="auto">
        <source src="/static/sounds/win.mp3" type="audio/mpeg">
    </audio>
    <script>
        (function(){
            const a = document.getElementById('sndWin');
            if (a) {
                try { a.currentTime = 0; a.play().catch(()=>{}); } catch(_) {}
            }
        })();
    </script>

    {{if .IsOnline}}
    <script>
        (function(){
            const code     = "{{.LobbyCode}}";
            const mySide   = "{{if .ThisIsRed}}R{{else}}Y{{end}}";
            const statusEl = document.getElementById("rematchStatus");

            async function tick(){
                try{
                    const res = await fetch("/online/state?code=" + encodeURIComponent(code), {
                        cache: "no-store"
                    });
                    if (!res.ok) return;
                    const j = await res.json();

                    if (typeof j.rematchR !== "undefined" &&
                        typeof j.rematchY !== "undefined" &&
                        statusEl){
                        const votes = (j.rematchR ? 1 : 0) + (j.rematchY ? 1 : 0);
                        statusEl.textContent = "Revanche : " + votes + "/2 pr√™ts";
                    }

                    if (!j.gameOver && j.turns === 0){
                        location.href = "/online/wait?code=" + encodeURIComponent(code) + "&side=" + mySide;
                    }
                }catch(e){}
            }

            setInterval(tick, 1200);
            tick();
        })();
    </script>
    {{end}}

    <div class="actions" style="margin-top:1.2rem; display:flex; gap:.75rem; justify-content:center; flex-wrap:wrap;">
        {{if .IsOnline}}
        <form method="post" action="/online/replay">
            <input type="hidden" name="code" value="{{.LobbyCode}}">
            <input type="hidden" name="side" value="{{if .ThisIsRed}}R{{else}}Y{{end}}">
            <button type="submit">üîÅ Demander une revanche</button>
        </form>
        {{else}}
        <form method="post" action="/replay">
            <button type="submit">üîÅ Revanche</button>
        </form>
        {{end}}

        <form method="post" action="/reset">
            <button type="submit">üè† Menu</button>
        </form>
    </div>
</section>
{{end}}
