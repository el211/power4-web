{{define "start_topright"}}
<button id="bgmToggle" class="btn-secondary" type="button" title="Activer/dÃ©sactiver la musique">
    ðŸ”‡ Musique: off
</button>
{{end}}

{{define "start_content"}}
<section class="card">
    <h2>DÃ©marrer une partie</h2>

    <!-- novalidate disables HTML5 popups; server trims/validates -->
    <form method="post" action="/start" class="start-form" novalidate>
        <div class="row">
            <label>Mode</label>
            <select name="mode" required>
                <option value="local">Local (2 joueurs sur ce PC)</option>
                <option value="ai">Contre lâ€™IA</option>
                <option value="online">En ligne (2 PCs)</option>
            </select>
        </div>

        <div class="row">
            <label>Joueur Rouge</label>
            <input type="text" name="player1" placeholder="Rouge" value="{{.Player1}}" />
        </div>
        <div class="row">
            <label>Joueur Jaune</label>
            <input type="text" name="player2" placeholder="Jaune" value="{{.Player2}}" />
        </div>

        <div class="row">
            <label>DifficultÃ©</label>
            <select name="difficulty">
                <option value="easy"   {{if eq .Difficulty "easy"}}selected{{end}}>Easy â€” 6Ã—7 â€¢ 3 blocs</option>
                <option value="normal" {{if eq .Difficulty "normal"}}selected{{end}}>Normal â€” 6Ã—9 â€¢ 5 blocs</option>
                <option value="hard"   {{if eq .Difficulty "hard"}}selected{{end}}>Hard â€” 7Ã—8 â€¢ 7 blocs</option>
            </select>
        </div>

        <details class="row">
            <summary>Options en ligne</summary>
            <div class="inline">
                <!-- IMPORTANT: no pattern; maxlength only -->
                <input type="text" name="lobby_code"
                       placeholder="Code pour Rejoindre (ex: 9RR2)"
                       maxlength="10" autocomplete="off" autocapitalize="characters" />
                <!-- Create: never validate code field -->
                <button type="submit" name="online_action" value="create" class="btn-secondary" formnovalidate>
                    ðŸ†• CrÃ©er une salle (code auto)
                </button>
                <!-- Join submits normally; server uppercases/validates -->
                <button type="submit" name="online_action" value="join" class="btn-secondary">
                    ðŸ”— Rejoindre (avec code)
                </button>
            </div>
            <div class="hint">Ces boutons utilisent automatiquement le mode <em>En ligne</em>.</div>
        </details>

        <div class="row">
            <!-- Big button also bypasses browser validation -->
            <button type="submit" class="btn-primary" formnovalidate>ðŸš€ Lancer la partie</button>
        </div>
    </form>

    <!-- Musique de fond du menu -->
    <audio id="bgmMenu" preload="auto" loop>
        <source src="/static/sounds/menu_bgm.mp3" type="audio/mpeg">
    </audio>
</section>

<script>
    (function(){
        const bgm = document.getElementById('bgmMenu');
        const btn = document.getElementById('bgmToggle');

        const PREF_KEY = 'pg_bgm_on';     // 'true' | 'false'
        const VOL_KEY  = 'pg_bgm_vol';    // 0..1 (float)
        const DEFAULT_TARGET_VOL = 0.35;

        // Ã©tat initial (ON par dÃ©faut)
        let prefOn = (localStorage.getItem(PREF_KEY) ?? 'true') === 'true';
        let targetVol = parseFloat(localStorage.getItem(VOL_KEY) || String(DEFAULT_TARGET_VOL));
        if (Number.isNaN(targetVol)) targetVol = DEFAULT_TARGET_VOL;

        // DÃ©marrer MUET (autoplay autorisÃ©), on fera un fade-in au 1er geste si ON
        bgm.volume = 0;
        bgm.muted = true;
        bgm.play().catch(()=>{}); // si Ã§a Ã©choue, on rÃ©essaiera aprÃ¨s un geste

        function setBtnLabel(){
            if (!btn) return;
            btn.textContent = prefOn ? 'ðŸ”Š Musique: on' : 'ðŸ”‡ Musique: off';
        }

        function fadeTo(vTarget, ms){
            const start = bgm.volume;
            const t0 = performance.now();
            function step(t){
                const k = Math.min(1, (t - t0) / ms);
                bgm.volume = start + (vTarget - start) * k;
                if (k < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // Armement au premier geste utilisateur
        let armed = false;
        function armOnce(){
            if (armed) return;
            armed = true;
            if (prefOn){
                bgm.muted = false;
                bgm.play().then(()=>fadeTo(targetVol, 500)).catch(()=>{});
            }
        }
        const onceOpt = { once:true, passive:true };
        window.addEventListener('pointerdown', armOnce, onceOpt);
        window.addEventListener('keydown',     armOnce, onceOpt);
        window.addEventListener('touchstart',  armOnce, onceOpt);

        // Toggle bouton
        if (btn){
            btn.addEventListener('click', () => {
                prefOn = !prefOn;
                localStorage.setItem(PREF_KEY, String(prefOn));
                setBtnLabel();
                if (prefOn){
                    if (!armed) armOnce();        // dÃ©clenche le dÃ©-mute au besoin
                    else {
                        bgm.muted = false;
                        if (bgm.paused) bgm.play().catch(()=>{});
                        fadeTo(targetVol, 250);
                    }
                } else {
                    fadeTo(0, 200);
                    setTimeout(()=>{ bgm.muted = true; }, 220);
                }
            });
        }

        // Si on revient sur lâ€™onglet et que lâ€™utilisateur a dÃ©jÃ  interagi : relance douce
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && prefOn && armed){
                bgm.muted = false;
                bgm.play().catch(()=>{});
                fadeTo(targetVol, 200);
            }
        });

        // Optionnel : rÃ©gler le volume avec Ctrl/Alt + molette
        window.addEventListener('wheel', (e) => {
            if (!(e.ctrlKey || e.altKey)) return;
            e.preventDefault();
            targetVol = Math.max(0, Math.min(1, targetVol + (e.deltaY < 0 ? 0.05 : -0.05)));
            localStorage.setItem(VOL_KEY, String(targetVol));
            if (prefOn){
                bgm.muted = false;
                if (bgm.paused) bgm.play().catch(()=>{});
                bgm.volume = targetVol;
            }
        }, { passive:false });

        setBtnLabel();
    })();
</script>
{{end}}
